# rtems-top

Top-level build directory for RTEMS 7.0 at SLAC. Contains useful patches and helper scripts for compiling things.

## Cloning & Updating

### Initial Clone

Clone into your directory of choice with --recursive
```sh
cd /sdf/sw/epics/package/rtems
git clone git@github.com:JJL772/rtems-top.git --recursive 7.0
```

After that, you're good to go.

### Pulling Latest

When updating from the upstream, make sure to run the following commands from the top-level directory:
```sh
git pull # Update the branch to latest
git submodule sync # Ensure the submodule URLs are up to date
git submodule update --recursive
```

This will ensure that all submodules are up to date and checking out the correct revisions.

## System Requirements

The following applications are required to build RTEMS:
1. Python 3.11+ (for the toml library)
2. git
3. bash

Generally a newer OS is better. i.e. choose rocky 9 over rhel 7, if you can, otherwise the source builder may fail in unexpected ways.

## Building

### Step 0: Building a Toolchain

The first step in any cross compiling journey is to assemble a toolchain. Unfortunately this takes a while, especially on
networked file systems like NFS. I highly recommend using a scratch area (i.e. /scratch on dev-epicsgw) to build the toolchain.
Otherwise you may be waiting a few days.

A pre-built toolchain may be fetched using `./fetch-toolchain.sh`. Though the best practice is BYOT (Bring Your Own Toolchain).

To build all necessary toolchains, run:
```
./src/build-toolchain.sh
```

The toolchain will be installed to `host/linux-x86_64` when done compiling.

### Step 1: Configuring

`configure.py` handles the configuration of RTEMS and related packages. 

To configure all packages for all relevant architectures:
```sh
./configure.py --project all
```

To configure for a specific package and BSP:
```
./configure.py --project rtems --rtems-bsps i386/pc686
```

### Step 2: Building and Installing

Installed target files will be located in `target/`

#### Method 1: Automatic Building

`configure.py` also has an option to build+install everything:
```
./configure.py --project all --build
```

#### Method 2: Manual Building

The build order of projects is generally:
0. rtems-tools
1. rtems
2. rtems-libbsd
3. rtems-net-legacy
4. rtems-net-services
5. rtems-init

After configuration by `configure.py`, the projects may be built and installed using `./waf install`,
with exception to rtems-init, which uses CMake.

## Development

### Updating Submodules to Latest Revisions

`checkout-latest.py` can be used to pull the absolute latest revision of each submodule.
The branches defined in `.gitmodules` will be fetched and pulled in each submodule.
After this is done, you should commit the resulting changes to ensure that the revisions are properly tracked.


### Adding a New BSP

Each BSP must have an entry in `bsps.toml`. This script is used by `configure.py` to determine which
packages it needs to configure, and where to pull the RTEMS configuration from.

Additionally, you'll need to add a new template INI file to `configs/`. The name of the file should be
in the format `rtems-config.${BSP}.ini`, although the specific name may be overridden by the `cfg=` key in
`bsps.toml`.

These files are generated by running the following in `src/rtems`:
```sh
./waf bspdefaults --rtems-bsps=powerpc/${BSP} > ../../configs/rtems-config.${BSP}.ini
```

Where `${BSP}` is replaced by your BSP name (ex: powerpc/beatnik).

The following settings must be changed in the resulting config:
```
# Both required for EPICS support
RTEMS_POSIX_API = True
INSTALL_LEGACY_MAKEFILES = True
```

